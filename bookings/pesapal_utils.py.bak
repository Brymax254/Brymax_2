import requests
import logging
import uuid
from django.conf import settings

logger = logging.getLogger(__name__)


def normalize_phone_number(phone: str) -> str:
    """Ensure phone numbers are in international format (+254...)."""
    if not phone:
        return "+254700000000"  # Default fallback
    phone = phone.strip().replace(" ", "")
    if phone.startswith("0"):
        phone = "+254" + phone[1:]
    elif not phone.startswith("+"):
        phone = "+254" + phone
    return phone


def get_access_token():
    """
    Authenticate with Pesapal v3 API and return an access token.
    """
    url = settings.PESAPAL_TOKEN_URL
    payload = {
        "consumer_key": settings.PESAPAL_CONSUMER_KEY,
        "consumer_secret": settings.PESAPAL_CONSUMER_SECRET
    }
    headers = {"Content-Type": "application/json"}

    try:
        response = requests.post(
            url,
            json=payload,
            headers=headers,
            timeout=30
        )
        response.raise_for_status()
        data = response.json()
        return data.get("token")
    except Exception as e:
        logger.error(
            "Failed to get Pesapal token: %s | Response: %s",
            e,
            getattr(e.response, "text", None)
        )
        return None


def create_pesapal_order(order_id, amount, description, email, phone, first_name, last_name):
    """
    Create a Pesapal order using v3 API.
    Returns: (redirect_url, merchant_ref, tracking_id)
    """
    token = get_access_token()
    if not token:
        logger.error("Failed to get access token for Pesapal order")
        return None, None, None

    url = settings.PESAPAL_PAYMENT_URL
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json",
        "Accept": "application/json",
    }

    # Generate a unique merchant reference
    merchant_ref = f"{order_id}-{uuid.uuid4().hex[:8]}"

    payload = {
        "id": merchant_ref,
        "amount": str(amount),
        "currency": "KES",
        "description": description,
        "callback_url": settings.PESAPAL_CALLBACK_URL,
        "notification_id": settings.PESAPAL_NOTIFICATION_ID,
        "billing_address": {
            "email_address": email,
            "phone_number": normalize_phone_number(phone),
            "first_name": first_name,
            "last_name": last_name,
            "country_code": "KE",
        },
    }

    logger.info(f"Creating Pesapal order with payload: {payload}")

    try:
        response = requests.post(url, json=payload, headers=headers, timeout=30)
        response.raise_for_status()
        data = response.json()

        redirect_url = data.get("redirect_url")
        tracking_id = data.get("order_tracking_id")

        logger.info(f"Pesapal order created successfully. Tracking ID: {tracking_id}")

        return (
            redirect_url,
            merchant_ref,
            tracking_id,
        )
    except Exception as e:
        logger.error("Pesapal order creation failed: %s", e)
        if hasattr(e, 'response') and e.response is not None:
            logger.error(f"Response content: {e.response.text}")
        return None, None, None