{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Tour | Safari Adventures Kenya</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js for dynamic behavior -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --safari-green: #1a6d4c;
            --safari-sand: #fdf3e7;
            --safari-accent: #d4a574;
            --safari-sky: #0ea5e9;
            --safari-earth: #8b4513;
            --light-bg: #f8f9fa;
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9fa, #e9f5f1);
            color: #333;
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
        }

        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .form-header {
            background: linear-gradient(135deg, var(--safari-green), var(--safari-earth));
            color: white;
            padding: 3rem;
            border-radius: 1.5rem;
            margin-bottom: 2.5rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            position: relative;
        }

        .form-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .form-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .section-card {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: var(--transition);
            background: white;
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }

        .section-header {
            padding: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .section-header i {
            font-size: 1.5rem;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            color: white;
        }

        /* Icon backgrounds */
        .basic-info .section-header i { background: linear-gradient(135deg, var(--safari-green), #2a8c5f); }
        .itinerary .section-header i { background: linear-gradient(135deg, var(--safari-sky), #38bdf8); }
        .pricing .section-header i { background: linear-gradient(135deg, #10b981, #34d399); }
        .duration .section-header i { background: linear-gradient(135deg, var(--safari-accent), #e6b88a); }
        .group-size .section-header i { background: linear-gradient(135deg, #6366f1, #818cf8); }
        .media .section-header i { background: linear-gradient(135deg, #4b5563, #6b7280); }
        .location .section-header i { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
        .sustainability .section-header i { background: linear-gradient(135deg, #22c55e, #4ade80); }
        .accessibility .section-header i { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .health-safety .section-header i { background: linear-gradient(135deg, #ef4444, #f87171); }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
        }

        .section-body {
            padding: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control, .form-select {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: var(--transition);
            width: 100%;
            font-size: 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--safari-green);
            box-shadow: 0 0 0 0.25rem rgba(26, 109, 76, 0.25);
            outline: none;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        .form-check-input:checked {
            background-color: var(--safari-green);
            border-color: var(--safari-green);
        }

        .form-check-label {
            cursor: pointer;
            font-weight: 500;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--safari-green), var(--safari-earth));
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 2rem;
            box-shadow: 0 4px 15px rgba(26, 109, 76, 0.3);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 2.5rem auto 0;
            cursor: pointer;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(26, 109, 76, 0.4);
        }

        .json-field {
            position: relative;
        }

        .json-field .form-control {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .json-hint {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .image-upload {
            position: relative;
        }

        .image-upload .form-control {
            padding-left: 3rem;
        }

        .image-upload::before {
            content: "\f03e";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-row .section-card {
            flex: 1;
            margin-bottom: 0;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            min-width: 300px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #f87171);
        }

        /* Progress indicator */
        .progress-container {
            margin: 2rem 0;
        }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--safari-green), var(--safari-earth));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }

        .progress-step {
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .progress-step.active {
            color: var(--safari-green);
            font-weight: 600;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-header {
                padding: 2rem 1.5rem;
            }

            .form-header h1 {
                font-size: 2rem;
            }

            .section-header {
                padding: 1rem;
            }

            .section-body {
                padding: 1rem;
            }

            .form-row {
                flex-direction: column;
                gap: 1rem;
            }

            .toast {
                right: 1rem;
                left: 1rem;
                min-width: auto;
            }
        }
    </style>
</head>
<body x-data="tourForm()">
    <div class="form-container">
        <div class="form-header">
            <h1>Create a New Safari Tour</h1>
            <p>Design an unforgettable experience for your guests with our comprehensive tour creation tool</p>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" :style="`width: ${progressPercentage}%`"></div>
            </div>
            <div class="progress-steps">
                <div class="progress-step" :class="{'active': currentSection >= 1}">Basic Info</div>
                <div class="progress-step" :class="{'active': currentSection >= 2}">Details</div>
                <div class="progress-step" :class="{'active': currentSection >= 3}">Pricing & Duration</div>
                <div class="progress-step" :class="{'active': currentSection >= 4}">Additional Info</div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate
              @submit.prevent="submitForm" :class="{ 'loading': isLoading }">
            {% csrf_token %}

            <!-- Basic Info Section -->
            <div class="section-card basic-info" id="section-1">
                <div class="section-header">
                    <i class="fas fa-info-circle"></i>
                    <h3 class="section-title">Basic Information</h3>
                </div>
                <div class="section-body">
                    <div class="form-group mb-4">
                        <label class="form-label">Tour Title *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">Tagline</label>
                        {{ form.tagline }}
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">Description *</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        {{ form.category }}
                    </div>
                </div>
            </div>

            <!-- Itinerary & Highlights Section -->
            <div class="section-card itinerary" id="section-2">
                <div class="section-header">
                    <i class="fas fa-route"></i>
                    <h3 class="section-title">Itinerary Details</h3>
                </div>
                <div class="section-body">
                    <div class="form-group mb-4">
                        <label class="form-label">Tour Highlights</label>
                        {{ form.highlights }}
                    </div>
                    <div class="form-group mb-4 json-field">
                        <label class="form-label">Itinerary (JSON format)</label>
                        {{ form.itinerary }}
                        <div class="json-hint">Format: [{"day": 1, "title": "Day 1", "description": "Activities..."}]</div>
                    </div>
                    <div class="form-group mb-4 json-field">
                        <label class="form-label">Inclusions (JSON format)</label>
                        {{ form.inclusions }}
                        <div class="json-hint">Format: ["Accommodation", "Meals", "Transport"]</div>
                    </div>
                    <div class="form-group json-field">
                        <label class="form-label">Exclusions (JSON format)</label>
                        {{ form.exclusions }}
                        <div class="json-hint">Format: ["International flights", "Travel insurance"]</div>
                    </div>
                </div>
            </div>

            <div class="form-row" id="section-3">
                <!-- Pricing Card -->
                <div class="section-card pricing">
                    <div class="section-header">
                        <i class="fas fa-tag"></i>
                        <h3 class="section-title">Pricing</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-group mb-4">
                            <label class="form-label">Price per Person *</label>
                            {{ form.price_per_person }}
                            {% if form.price_per_person.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.price_per_person.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label">Discount Price</label>
                            {{ form.discount_price }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            {{ form.currency }}
                        </div>
                    </div>
                </div>

                <!-- Duration Card -->
                <div class="section-card duration">
                    <div class="section-header">
                        <i class="fas fa-clock"></i>
                        <h3 class="section-title">Duration</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-group mb-4">
                            <label class="form-label">Days *</label>
                            {{ form.duration_days }}
                            {% if form.duration_days.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.duration_days.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label">Nights</label>
                            {{ form.duration_nights }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty Level</label>
                            {{ form.difficulty }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <!-- Group Size Card -->
                <div class="section-card group-size">
                    <div class="section-header">
                        <i class="fas fa-users"></i>
                        <h3 class="section-title">Group Size</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-group mb-4">
                            <label class="form-label">Minimum Group Size</label>
                            {{ form.min_group_size }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Maximum Group Size</label>
                            {{ form.max_group_size }}
                        </div>
                    </div>
                </div>

                <!-- Media Card -->
                <div class="section-card media">
                    <div class="section-header">
                        <i class="fas fa-images"></i>
                        <h3 class="section-title">Media</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-group mb-4 image-upload">
                            <label class="form-label">Main Image</label>
                            {{ form.image }}
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label">Video URL</label>
                            {{ form.video }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">External Image URL</label>
                            {{ form.image_url }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Section -->
            <div class="section-card location" id="section-4">
                <div class="section-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3 class="section-title">Location</h3>
                </div>
                <div class="section-body">
                    <div class="form-group mb-4">
                        <label class="form-label">Departure Point</label>
                        {{ form.departure_point }}
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">Destinations Visited</label>
                        {{ form.destinations_visited }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Destinations (Multi-select)</label>
                        {{ form.destinations }}
                    </div>
                </div>
            </div>

            <div class="form-row">
                <!-- Sustainability Card -->
                <div class="section-card sustainability">
                    <div class="section-header">
                        <i class="fas fa-leaf"></i>
                        <h3 class="section-title">Sustainability</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-check mb-4">
                            {{ form.eco_friendly }}
                            <label class="form-check-label" for="{{ form.eco_friendly.id_for_label }}">Eco Friendly Tour</label>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label">Carbon Footprint per Person (kg CO2)</label>
                            {{ form.carbon_footprint_per_person }}
                        </div>
                        <div class="form-group json-field">
                            <label class="form-label">Sustainability Certifications (JSON format)</label>
                            {{ form.sustainability_certifications }}
                            <div class="json-hint">Format: ["Certification Name", "Year"]</div>
                        </div>
                    </div>
                </div>

                <!-- Accessibility Card -->
                <div class="section-card accessibility">
                    <div class="section-header">
                        <i class="fas fa-universal-access"></i>
                        <h3 class="section-title">Accessibility</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-check mb-4">
                            {{ form.wheelchair_accessible }}
                            <label class="form-check-label" for="{{ form.wheelchair_accessible.id_for_label }}">Wheelchair Accessible</label>
                        </div>
                        <div class="form-group json-field">
                            <label class="form-label">Accessibility Features (JSON format)</label>
                            {{ form.accessibility_features }}
                            <div class="json-hint">Format: ["Ramp access", "Accessible restrooms"]</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health & Safety Section -->
            <div class="section-card health-safety">
                <div class="section-header">
                    <i class="fas fa-shield-alt"></i>
                    <h3 class="section-title">Health & Safety</h3>
                </div>
                <div class="section-body">
                    <div class="form-group mb-4 json-field">
                        <label class="form-label">Health & Safety Measures (JSON format)</label>
                        {{ form.health_safety_measures }}
                        <div class="json-hint">Format: ["First aid trained guides", "Emergency protocols"]</div>
                    </div>
                    <div class="form-group json-field">
                        <label class="form-label">COVID-19 Protocols (JSON format)</label>
                        {{ form.covid19_protocols }}
                        <div class="json-hint">Format: ["Sanitized vehicles", "Social distancing"]</div>
                    </div>
                </div>
            </div>

            <!-- Tour Status (Auto-set by system) -->
            <div class="section-card">
                <div class="section-header">
                    <i class="fas fa-cogs"></i>
                    <h3 class="section-title">Tour Status (Auto-configured)</h3>
                </div>
                <div class="section-body">
                    <div class="bg-safari-sand p-4 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-info-circle text-safari-green mr-2"></i>
                            New tours are automatically set as <strong>pending approval</strong> and <strong>not available</strong> until approved by an administrator.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-8">
                <button type="button" @click="previousSection"
                        class="px-6 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors"
                        x-show="currentSection > 1">
                    <i class="fas fa-arrow-left mr-2"></i> Previous Section
                </button>

                <button type="button" @click="nextSection"
                        class="px-6 py-3 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700 transition-colors"
                        x-show="currentSection < 4">
                    Next Section <i class="fas fa-arrow-right ml-2"></i>
                </button>

                <button type="submit" class="submit-btn" x-show="currentSection === 4">
                    <i class="fas fa-save" x-show="!isLoading"></i>
                    <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                    <span x-text="isLoading ? 'Creating Tour...' : 'Save Tour'"></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Toast Notification -->
    <div class="toast" :class="messageType" x-show="message" x-transition>
        <i :class="messageType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
        <span x-text="message"></span>
    </div>

    <script>
        function tourForm() {
            return {
                isLoading: false,
                message: '',
                messageType: '',
                currentSection: 1,
                totalSections: 4,

                get progressPercentage() {
                    return (this.currentSection / this.totalSections) * 100;
                },

                nextSection() {
                    if (this.currentSection < this.totalSections) {
                        this.currentSection++;
                        this.scrollToSection();
                    }
                },

                previousSection() {
                    if (this.currentSection > 1) {
                        this.currentSection--;
                        this.scrollToSection();
                    }
                },

                scrollToSection() {
                    const section = document.getElementById(`section-${this.currentSection}`);
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                },

                async submitForm() {
                    this.isLoading = true;
                    this.message = '';

                    try {
                        const form = this.$el;
                        const formData = new FormData(form);

                        // Add auto-generated fields
                        formData.append('available', 'false');
                        formData.append('is_approved', 'false');
                        formData.append('created_by', '{{ request.user.id }}');

                        const response = await fetch('{% url "create_tour" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            this.message = data.message || 'Tour created successfully! Redirecting...';
                            this.messageType = 'success';

                            // Redirect after delay
                            setTimeout(() => {
                                window.location.href = data.redirect_url || '{% url "driver_dashboard" %}';
                            }, 2000);
                        } else {
                            this.message = data.error || 'Error creating tour. Please check the form and try again.';
                            this.messageType = 'error';

                            // Display field errors if any
                            if (data.errors) {
                                this.displayFieldErrors(data.errors);
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.message = 'Network error. Please try again.';
                        this.messageType = 'error';
                    } finally {
                        this.isLoading = false;
                    }
                },

                displayFieldErrors(errors) {
                    // Clear previous errors
                    document.querySelectorAll('.field-error').forEach(el => el.remove());

                    // Display new errors
                    for (const [field, messages] of Object.entries(errors)) {
                        const input = document.querySelector(`[name="${field}"]`);
                        if (input) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'field-error text-red-500 text-sm mt-1';
                            errorDiv.innerHTML = messages.join('<br>');
                            input.parentNode.appendChild(errorDiv);
                        }
                    }
                },

                // Auto-calculate nights based on days
                calculateNights() {
                    const daysInput = document.querySelector('[name="duration_days"]');
                    const nightsInput = document.querySelector('[name="duration_nights"]');

                    if (daysInput && nightsInput) {
                        daysInput.addEventListener('input', (e) => {
                            const days = parseInt(e.target.value) || 0;
                            if (days > 0) {
                                nightsInput.value = days - 1;
                            }
                        });
                    }
                },

                init() {
                    this.calculateNights();

                    // Set up form validation
                    const forms = document.querySelectorAll('.needs-validation');
                    Array.from(forms).forEach(form => {
                        form.addEventListener('submit', event => {
                            if (!form.checkValidity()) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    });
                }
            }
        }
    </script>
</body>
</html>