{% load static humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}" />
  <meta name="theme-color" content="#4f46e5" />
  <title>Secure Payment - SafariAdventures</title>

  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome 6.4.0 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #f59e0b;
      --accent: #818cf8;
      --light: #f5f3ff;
      --dark: #1e1b4b;
      --gray: #64748b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
      color: #334155;
      line-height: 1.6;
      min-height: 100vh;
    }

    .gradient-bg {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card:hover {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      font-weight: 600;
      padding: 14px 28px;
      border-radius: 12px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .input-field {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title i {
      color: var(--primary);
      font-size: 1.5rem;
    }

    .payment-container {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      border-radius: 20px;
      padding: 2rem;
      position: relative;
      overflow: hidden;
    }

    .payment-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23818cf8' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
      pointer-events: none;
    }

    .pesapal-iframe {
      width: 100%;
      min-height: 600px;
      border: none;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      background: white;
      transition: all 0.3s ease;
    }

    .pesapal-iframe:hover {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .feature-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.3s ease;
    }

    .feature-card {
      padding: 1.5rem;
      border-radius: 16px;
      background: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .feature-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .feature-card:hover .feature-icon {
      background: var(--primary);
      color: white;
    }

    .faq-item {
      border-bottom: 1px solid #e2e8f0;
      padding: 1.25rem 0;
      transition: all 0.3s ease;
    }

    .faq-item:hover {
      background: rgba(79, 70, 229, 0.03);
      margin: 0 -1rem;
      padding: 1.25rem 1rem;
      border-radius: 12px;
    }

    .faq-question {
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      color: var(--dark);
    }

    .faq-answer {
      margin-top: 1rem;
      color: var(--gray);
      line-height: 1.6;
    }

    .countdown {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--light);
      color: var(--primary);
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .order-summary {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(129, 140, 248, 0.2);
    }

    .order-line {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
    }

    .order-line .label {
      color: var(--gray);
      font-weight: 500;
    }

    .order-line .value {
      font-weight: 600;
      color: var(--dark);
    }

    .order-total {
      border-top: 1px solid #c7d2fe;
      padding-top: 1rem;
      margin-top: 1rem;
    }

    .order-total .value {
      color: var(--primary);
      font-size: 1.5rem;
      font-weight: 700;
    }

    .security-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 0.875rem;
      color: var(--gray);
      backdrop-filter: blur(10px);
    }

    .security-badge i {
      color: var(--success);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    .payment-processing {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .processing-content {
      text-align: center;
      max-width: 500px;
      padding: 2rem;
    }

    .processing-spinner {
      width: 80px;
      height: 80px;
      border: 8px solid #f3f4f6;
      border-top: 8px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary);
    }

    .toast-notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-notification.success {
      border-left-color: var(--success);
    }

    .toast-notification.error {
      border-left-color: var(--danger);
    }

    .toast-icon {
      font-size: 24px;
    }

    .toast-notification.success .toast-icon {
      color: var(--success);
    }

    .toast-notification.error .toast-icon {
      color: var(--danger);
    }

    .payment-method-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .payment-method-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .payment-method-card.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(129, 140, 248, 0.1) 100%);
    }

    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @media (max-width: 768px) {
      .pesapal-iframe {
        min-height: 500px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="gradient-bg text-white py-6 px-4 md:px-8">
    <div class="container mx-auto">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center">
          <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center mr-4 backdrop-filter backdrop-blur-sm">
            <i class="fas fa-paw text-3xl text-amber-300"></i>
          </div>
          <h1 class="text-3xl font-bold">Safari<span class="text-amber-300">Adventures</span></h1>
        </div>
        <div class="flex items-center gap-4">
          <div class="countdown pulse">
            <i class="fas fa-clock"></i>
            <span id="countdown-timer">15:00</span>
          </div>
          <div class="security-badge">
            <i class="fas fa-lock"></i>
            <span>Secure Payment</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Payment Form -->
      <div class="lg:col-span-2">
        <!-- Guest Information -->
        <div id="guest-form" class="card mb-8 p-6 md:p-8">
          <h2 class="section-title">
            <i class="fas fa-user-circle"></i>
            Traveler Information
          </h2>
          <p class="text-gray-600 mb-6">Please provide your details to complete the booking</p>

          <form id="guest-info-form" method="POST" action="{% url 'tour_payment_page' tour.id %}">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-gray-700 font-medium mb-2">Full Name *</label>
                <input type="text" id="full-name" name="full_name" required
                  class="input-field" placeholder="John Doe" />
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Email Address *</label>
                <input type="email" id="guest-email" name="email" required
                  class="input-field" placeholder="john@example.com" />
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Phone Number *</label>
              <div class="flex">
                <select id="country-code" name="country_code" class="input-field w-1/3 rounded-r-none">
                  <option value="+254">+254 (KE)</option>
                  <option value="+255">+255 (TZ)</option>
                  <option value="+256">+256 (UG)</option>
                </select>
                <input type="tel" id="phone" name="phone" required
                  class="input-field flex-1 rounded-l-none" placeholder="712 345 678" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div>
                <label class="block text-gray-700 font-medium mb-2">Adults *</label>
                <input type="number" id="adults" name="adults" min="1" required
                  class="input-field" value="1" />
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Children</label>
                <input type="number" id="children" name="children" min="0"
                  class="input-field" value="0" />
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Days *</label>
                <input type="number" id="days" name="days" min="1"
                  class="input-field" value="{{ tour.duration_days }}" />
              </div>
            </div>

            <div class="mb-8">
              <label class="block text-gray-700 font-medium mb-2">Travel Date *</label>
              <input type="date" id="travel-date" name="travel_date" required
                min="{{ today|date:'Y-m-d' }}" class="input-field" />
            </div>

            <button type="submit" id="continue-btn" class="btn-primary w-full">
              <span>Continue to Payment</span>
              <i class="fas fa-arrow-right"></i>
            </button>
          </form>
        </div>

        <!-- Payment Section -->
        <div id="payment-section" class="card p-6 md:p-8 hidden">
          <h2 class="section-title">
            <i class="fas fa-credit-card"></i>
            Complete Your Payment
          </h2>

          <!-- Modern Guest Summary -->
          <div class="order-summary mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
              <i class="fas fa-receipt mr-3 text-indigo-600"></i> Booking Summary
            </h3>

            <div class="bg-white rounded-xl p-6 shadow-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-user text-indigo-600"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Traveler</p>
                    <p class="font-medium text-gray-800" id="summary-name">-</p>
                  </div>
                </div>

                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-envelope text-indigo-600"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p class="font-medium text-gray-800" id="summary-email">-</p>
                  </div>
                </div>

                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-phone text-indigo-600"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Phone</p>
                    <p class="font-medium text-gray-800" id="summary-phone">-</p>
                  </div>
                </div>

                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-calendar text-indigo-600"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Travel Date</p>
                    <p class="font-medium text-gray-800" id="summary-date">-</p>
                  </div>
                </div>

                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-users text-indigo-600"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Travelers</p>
                    <p class="font-medium text-gray-800" id="summary-travelers">-</p>
                  </div>
                </div>

                <div class="flex items-center">
                  <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-clock text-indigo-600"></i>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Duration</p>
                    <p class="font-medium text-gray-800" id="summary-days">-</p>
                  </div>
                </div>
              </div>

              <div class="border-t border-gray-200 pt-4 mt-4">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-600">Adult Cost</span>
                  <span class="font-medium" id="summary-adults-cost">-</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-600">Children Cost</span>
                  <span class="font-medium" id="summary-children-cost">-</span>
                </div>
                <div class="flex justify-between items-center pt-3 mt-3 border-t border-gray-200">
                  <span class="text-lg font-bold text-gray-800">Total Amount</span>
                  <span class="text-xl font-bold text-indigo-600" id="summary-total">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Payment Method</h3>
            <div class="payment-method-card active">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-14 h-14 rounded-xl bg-indigo-100 flex items-center justify-center mr-4">
                    <i class="fas fa-credit-card text-indigo-600 text-2xl"></i>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-800 text-lg">PesaPal</h4>
                    <p class="text-sm text-gray-600">Secure online payment</p>
                  </div>
                </div>
                <div class="flex space-x-3">
                  <div class="w-12 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <i class="fab fa-cc-visa text-gray-700 text-xl"></i>
                  </div>
                  <div class="w-12 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <i class="fab fa-cc-mastercard text-gray-700 text-xl"></i>
                  </div>
                  <div class="w-12 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <i class="fab fa-cc-amex text-gray-700 text-xl"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PesaPal Payment Container -->
          <div class="payment-container mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Enter Payment Details</h3>
            <div id="pesapal-container">
              <!-- Loading state -->
              <div id="pesapal-loading" class="flex flex-col items-center justify-center h-64">
                <div class="processing-spinner mb-4"></div>
                <p class="text-gray-600 font-medium">Initializing secure payment...</p>
                <p class="text-gray-500 text-sm mt-2">Please wait while we connect to PesaPal</p>
              </div>

              <!-- PesaPal iframe (hidden initially) -->
              <iframe
                id="pesapal-iframe"
                class="pesapal-iframe hidden"
                title="PesaPal Payment Form"
                loading="lazy">
              </iframe>

              <!-- Error state (hidden initially) -->
              <div id="pesapal-error" class="hidden p-8 bg-red-50 rounded-xl text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-red-800 mb-2">Payment Error</h3>
                <p class="text-red-600 mb-4">We couldn't initialize the payment. Please try again.</p>
                <button id="retry-payment" class="btn-primary">
                  <span>Try Again</span>
                  <i class="fas fa-redo"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Payment Features -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="feature-card">
              <div class="flex items-start">
                <div class="feature-icon mr-4">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800 mb-1">Secure Payments</h4>
                  <p class="text-gray-600 text-sm">Bank-level security with encryption and fraud protection</p>
                </div>
              </div>
            </div>
            <div class="feature-card">
              <div class="flex items-start">
                <div class="feature-icon mr-4">
                  <i class="fas fa-bolt"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800 mb-1">Instant Processing</h4>
                  <p class="text-gray-600 text-sm">Most payments are processed and confirmed instantly</p>
                </div>
              </div>
            </div>
          </div>

          <!-- FAQ -->
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-question-circle mr-2 text-indigo-600"></i>
              Frequently Asked Questions
            </h3>

            <div class="faq-item">
              <div class="faq-question">
                <span>What is included in the safari package?</span>
                <i class="fas fa-chevron-down text-indigo-600"></i>
              </div>
              <div class="faq-answer hidden">
                <p>Accommodation, meals, game drives, park entry fees, professional guide services, and transportation. Some packages may include cultural visits and activities.</p>
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">
                <span>What is the cancellation policy?</span>
                <i class="fas fa-chevron-down text-indigo-600"></i>
              </div>
              <div class="faq-answer hidden">
                <p>30+ days: full refund. 15â€“29 days: 50% refund. Within 14 days: no refund.</p>
              </div>
            </div>

            <div class="faq-item">
              <div class="faq-question">
                <span>What should I pack for the safari?</span>
                <i class="fas fa-chevron-down text-indigo-600"></i>
              </div>
              <div class="faq-answer hidden">
                <p>Neutral clothing, hat, sunscreen, binoculars, camera, comfortable shoes, and a light jacket for early drives.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Tour Details -->
      <div class="lg:col-span-1">
        <!-- Tour Summary -->
        <div class="card mb-8 p-6">
          <h2 class="section-title">
            <i class="fas fa-map-marked-alt"></i>
            Tour Details
          </h2>

          <div class="mb-6">
            <img src="{{ tour.image.url }}" alt="{{ tour.title }}"
              class="w-full h-48 object-cover rounded-xl" />
          </div>

          <h3 class="text-xl font-bold text-gray-800 mb-2">{{ tour.title }}</h3>
          <p class="text-gray-600 mb-4">{{ tour.description|truncatewords:20 }}</p>

          <div class="space-y-3 mb-6">
            <div class="flex justify-between">
              <span class="text-gray-600">Duration:</span>
              <span class="font-medium">{{ tour.duration_days }} days</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Price per person:</span>
              <span class="font-medium">KES {{ tour.price_per_person|intcomma }}</span>
            </div>
          </div>

          <div class="pt-4 border-t border-gray-200">
            <h4 class="font-semibold text-gray-800 mb-3">What's Included</h4>
            <ul class="space-y-2">
              <li class="flex items-center text-sm">
                <i class="fas fa-check text-green-500 mr-2"></i>
                <span>Park entry fees</span>
              </li>
              <li class="flex items-center text-sm">
                <i class="fas fa-check text-green-500 mr-2"></i>
                <span>Professional guide</span>
              </li>
              <li class="flex items-center text-sm">
                <i class="fas fa-check text-green-500 mr-2"></i>
                <span>Comfortable accommodation</span>
              </li>
              <li class="flex items-center text-sm">
                <i class="fas fa-check text-green-500 mr-2"></i>
                <span>Meals & drinking water</span>
              </li>
              <li class="flex items-center text-sm">
                <i class="fas fa-check text-green-500 mr-2"></i>
                <span>4x4 game drives</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Support -->
        <div class="card mb-8 p-6">
          <h2 class="section-title">
            <i class="fas fa-headset"></i>
            Need Help?
          </h2>

          <div class="space-y-4">
            <div class="flex items-center p-3 bg-indigo-50 rounded-lg">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-phone text-indigo-600"></i>
              </div>
              <a href="tel:+254700123456" class="text-gray-700 hover:text-indigo-600">+254 700 123456</a>
            </div>

            <div class="flex items-center p-3 bg-indigo-50 rounded-lg">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-envelope text-indigo-600"></i>
              </div>
              <a href="mailto:support@safariadventures.com" class="text-gray-700 hover:text-indigo-600">support@safariadventures.com</a>
            </div>

            <div class="flex items-center p-3 bg-indigo-50 rounded-lg cursor-pointer hover:bg-indigo-100">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-comments text-indigo-600"></i>
              </div>
              <span class="text-gray-700">Live Chat</span>
            </div>
          </div>
        </div>

        <!-- Security -->
        <div class="card p-6">
          <h2 class="section-title">
            <i class="fas fa-shield-alt"></i>
            Security & Protection
          </h2>

          <div class="space-y-4">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-lock text-indigo-600"></i>
              </div>
              <div>
                <h4 class="font-medium text-gray-800">256-bit SSL Encryption</h4>
                <p class="text-sm text-gray-600">Your data is encrypted and secure</p>
              </div>
            </div>

            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-shield-alt text-indigo-600"></i>
              </div>
              <div>
                <h4 class="font-medium text-gray-800">PCI DSS Compliant</h4>
                <p class="text-sm text-gray-600">Payment industry security standards</p>
              </div>
            </div>

            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-user-shield text-indigo-600"></i>
              </div>
              <div>
                <h4 class="font-medium text-gray-800">Privacy Protected</h4>
                <p class="text-sm text-gray-600">Your information is never shared</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-300 py-12 px-4 mt-16">
    <div class="container mx-auto max-w-6xl">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="text-xl font-bold text-white mb-4">Safari<span class="text-amber-300">Adventures</span></h3>
          <p class="mb-4">Creating unforgettable wildlife experiences since 2005.</p>
          <div class="flex space-x-4">
            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook"></i></a>
            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram"></i></a>
            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-twitter"></i></a>
            <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-youtube"></i></a>
          </div>
        </div>

        <div>
          <h4 class="text-lg font-semibold text-white mb-4">Quick Links</h4>
          <ul class="space-y-2">
            <li><a href="#" class="hover:text-white">About Us</a></li>
            <li><a href="#" class="hover:text-white">Safari Packages</a></li>
            <li><a href="#" class="hover:text-white">Testimonials</a></li>
            <li><a href="#" class="hover:text-white">Gallery</a></li>
          </ul>
        </div>

        <div>
          <h4 class="text-lg font-semibold text-white mb-4">Contact Info</h4>
          <ul class="space-y-2">
            <li class="flex items-start">
              <i class="fas fa-map-marker-alt mt-1 mr-2"></i>
              <span>Nairobi, Kenya</span>
            </li>
            <li class="flex items-center">
              <i class="fas fa-phone mr-2"></i>
              <span>+254 700 123456</span>
            </li>
            <li class="flex items-center">
              <i class="fas fa-envelope mr-2"></i>
              <span>info@safariadventures.com</span>
            </li>
          </ul>
        </div>

        <div>
          <h4 class="text-lg font-semibold text-white mb-4">Newsletter</h4>
          <p class="mb-4">Subscribe for special offers and safari tips</p>
          <form class="flex">
            <input type="email" placeholder="Your email"
              class="px-4 py-2 rounded-l-lg text-gray-800 w-full focus:outline-none" />
            <button class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg hover:bg-indigo-700">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>

      <div class="border-t border-gray-800 mt-8 pt-8 text-center text-sm">
        <p>&copy; {% now "Y" %} SafariAdventures. All rights reserved.</p>
        <div class="mt-2">
          <a href="#" class="mx-2 hover:text-white">Privacy Policy</a>
          <a href="#" class="mx-2 hover:text-white">Terms of Service</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Payment Processing Overlay -->
  <div id="payment-processing" class="payment-processing hidden">
    <div class="processing-content">
      <div class="processing-spinner"></div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Processing Your Payment</h3>
      <p class="text-gray-600 mb-6">Please wait while we initialize your secure payment with PesaPal.</p>
      <div class="bg-gray-100 p-4 rounded-lg text-left">
        <div class="flex items-center mb-3">
          <i class="fas fa-check-circle text-green-500 mr-2"></i>
          <span>Verifying your information</span>
        </div>
        <div class="flex items-center mb-3">
          <i class="fas fa-check-circle text-green-500 mr-2"></i>
          <span>Creating your booking</span>
        </div>
        <div class="flex items-center">
          <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-2"></div>
          <span>Initializing PesaPal payment</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast-notification">
    <i class="toast-icon"></i>
    <div>
      <div class="toast-title font-medium"></div>
      <div class="toast-message text-sm text-gray-600"></div>
    </div>
  </div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const guestForm = document.getElementById('guest-info-form');
  const continueBtn = document.getElementById('continue-btn');
  const paymentSection = document.getElementById('payment-section');
  const guestFormSection = document.getElementById('guest-form');
  const toast = document.getElementById('toast');
  const pesapalContainer = document.getElementById('pesapal-container');
  const pesapalLoading = document.getElementById('pesapal-loading');
  const pesapalIframe = document.getElementById('pesapal-iframe');
  const pesapalError = document.getElementById('pesapal-error');
  const retryPaymentBtn = document.getElementById('retry-payment');

  // Form inputs
  const nameInput = document.getElementById('full-name');
  const emailInput = document.getElementById('guest-email');
  const phoneInput = document.getElementById('phone');
  const codeInput = document.getElementById('country-code');
  const adultsInput = document.getElementById('adults');
  const childrenInput = document.getElementById('children');
  const daysInput = document.getElementById('days');
  const travelDateInput = document.getElementById('travel-date');

  // Summary elements
  const sName = document.getElementById('summary-name');
  const sEmail = document.getElementById('summary-email');
  const sPhone = document.getElementById('summary-phone');
  const sDate = document.getElementById('summary-date');
  const sTrav = document.getElementById('summary-travelers');
  const sDays = document.getElementById('summary-days');
  const sAdultsCost = document.getElementById('summary-adults-cost');
  const sChildrenCost = document.getElementById('summary-children-cost');
  const sTotal = document.getElementById('summary-total');

  // Pricing
  const pricePerPerson = Number('{{ tour.price_per_person|floatformat:2 }}');
  const durationDays = Number('{{ tour.duration_days }}');
  const dailyRate = durationDays > 0 ? (pricePerPerson / durationDays) : 0;

  // Format currency
  function formatKES(amount) {
    try {
      return new Intl.NumberFormat('en-KE', {
        style: 'currency',
        currency: 'KES',
        minimumFractionDigits: 0
      }).format(Math.round(amount));
    } catch (e) {
      return `KES ${Math.round(amount).toLocaleString('en-KE')}`;
    }
  }

  // Calculate order summary
  function recalc() {
    const adults = Math.max(parseInt(adultsInput.value || '0', 10), 0);
    const children = Math.max(parseInt(childrenInput.value || '0', 10), 0);
    const days = Math.max(parseInt(daysInput.value || '0', 10), 0);

    // Pricing logic
    const firstAdultCost = adults >= 1 ? (dailyRate * days) : 0;
    const additionalAdultsCost = adults > 1 ? ((adults - 1) * dailyRate * 0.9 * days) : 0;
    const childrenCost = children * dailyRate * 0.5 * days;
    const adultsCost = firstAdultCost + additionalAdultsCost;
    const total = adultsCost + childrenCost;

    // Update summary
    sName.textContent = nameInput.value || '-';
    sEmail.textContent = emailInput.value || '-';
    sPhone.textContent = phoneInput.value ? `${codeInput.value} ${phoneInput.value}` : '-';
    sDate.textContent = travelDateInput.value || '-';
    sTrav.textContent = `${adults} Adults, ${children} Children`;
    sDays.textContent = `${days} Days`;
    sAdultsCost.textContent = formatKES(adultsCost);
    sChildrenCost.textContent = formatKES(childrenCost);
    sTotal.textContent = formatKES(total);
  }

  // Add input listeners
  [nameInput, emailInput, phoneInput, codeInput, adultsInput, childrenInput, daysInput, travelDateInput].forEach(el => {
    if (el) el.addEventListener('input', recalc);
  });

  // Function to load PesaPal iframe
  function loadPesapalIframe() {
    // Show loading state
    pesapalLoading.classList.remove('hidden');
    pesapalIframe.classList.add('hidden');
    pesapalError.classList.add('hidden');

    // Get form data
    const formData = new FormData(guestForm);
    const data = {
      full_name: formData.get('full_name'),
      email: formData.get('email'),
      phone: formData.get('phone'),
      country_code: formData.get('country_code'),
      adults: formData.get('adults'),
      children: formData.get('children'),
      days: formData.get('days'),
      travel_date: formData.get('travel_date')
    };

    // Calculate total amount
    const adults = parseInt(data.adults || '0', 10);
    const children = parseInt(data.children || '0', 10);
    const days = parseInt(data.days || '0', 10);

    const firstAdultCost = adults >= 1 ? (dailyRate * days) : 0;
    const additionalAdultsCost = adults > 1 ? ((adults - 1) * dailyRate * 0.9 * days) : 0;
    const childrenCost = children * dailyRate * 0.5 * days;
    const adultsCost = firstAdultCost + additionalAdultsCost;
    const total = Math.round(adultsCost + childrenCost);

    console.log('Processing payment with data:', data, 'Total amount:', total);

    // First, process guest info
    fetch('/process-guest-info/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: new URLSearchParams({
        email: data.email,
        phone: data.country_code + data.phone
      })
    })
    .then(response => {
      console.log('Process guest info response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(result => {
      console.log('Process guest info result:', result);
      if (result.success) {
        // Now create the PesaPal order
        return fetch('/create-guest-pesapal-order/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          },
          body: JSON.stringify({
            amount: total,
            description: `Tour booking for {{ tour.title }}`,
            guest_info: {
              full_name: data.full_name,
              email: data.email,
              phone: data.country_code + data.phone,
              adults: data.adults,
              children: data.children,
              days: data.days,
              travel_date: data.travel_date
            }
          })
        });
      } else {
        throw new Error(result.message || 'Failed to process guest information');
      }
    })
    .then(response => {
      console.log('Create Pesapal order response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(result => {
      console.log('Create Pesapal order result:', result);
      if (result.success && result.redirect_url) {
        // Load PesaPal iframe
        pesapalIframe.src = result.redirect_url;
        pesapalIframe.onload = () => {
          console.log('PesaPal iframe loaded successfully');
          // Hide loading, show iframe
          pesapalLoading.classList.add('hidden');
          pesapalIframe.classList.remove('hidden');
        };

        // Set a timeout in case the iframe doesn't load
        setTimeout(() => {
          if (pesapalLoading.classList.contains('hidden') === false) {
            console.log('PesaPal iframe loading timeout');
            pesapalLoading.classList.add('hidden');
            pesapalError.classList.remove('hidden');
          }
        }, 10000); // 10 seconds timeout
      } else {
        throw new Error(result.message || 'Failed to initialize payment');
      }
    })
    .catch(error => {
      console.error('Payment initialization error:', error);

      // Show error state
      pesapalLoading.classList.add('hidden');
      pesapalError.classList.remove('hidden');

      // Show error message
      showToast('error', 'Payment Error', error.message || 'Failed to initialize payment. Please try again.');
    });
  }

  // Form submission handler
  if (guestForm) {
    guestForm.addEventListener('submit', (e) => {
      e.preventDefault();

      console.log("Form submitted!");

      // Simple validation
      if (!nameInput.value || !emailInput.value || !phoneInput.value) {
        console.log("Validation failed");
        showToast('error', 'Validation Error', 'Please fill in all required fields');
        return;
      }

      // Validate adults
      const adults = parseInt(adultsInput.value || '0', 10);
      if (adults < 1) {
        console.log("Adults validation failed");
        showToast('error', 'Validation Error', 'At least one adult is required');
        return;
      }

      console.log("Validation passed");

      // Show loading state on button
      continueBtn.disabled = true;
      continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

      // Calculate and display summary
      recalc();

      // Show payment section
      guestFormSection.classList.add('hidden');
      paymentSection.classList.remove('hidden');

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Load PesaPal iframe
      setTimeout(() => {
        console.log("About to load PesaPal iframe");
        loadPesapalIframe();

        // Reset button
        continueBtn.disabled = false;
        continueBtn.innerHTML = '<span>Continue to Payment</span> <i class="fas fa-arrow-right"></i>';
      }, 500);
    });
  }

  // Retry payment button handler
  if (retryPaymentBtn) {
    retryPaymentBtn.addEventListener('click', () => {
      loadPesapalIframe();
    });
  }

  // Toast notification function
  function showToast(type, title, message) {
    const toastEl = document.getElementById('toast');
    const toastIcon = toastEl.querySelector('.toast-icon');
    const toastTitle = toastEl.querySelector('.toast-title');
    const toastMessage = toastEl.querySelector('.toast-message');

    // Set toast content
    toastTitle.textContent = title;
    toastMessage.textContent = message;

    // Set toast type
    toastEl.className = 'toast-notification ' + type;

    // Set icon based on type
    if (type === 'success') {
      toastIcon.className = 'toast-icon fas fa-check-circle';
    } else if (type === 'error') {
      toastIcon.className = 'toast-icon fas fa-exclamation-circle';
    }

    // Show toast
    toastEl.classList.add('show');

    // Hide toast after 5 seconds
    setTimeout(() => {
      toastEl.classList.remove('show');
    }, 5000);
  }

  // FAQ toggles
  document.querySelectorAll('.faq-question').forEach(question => {
    question.addEventListener('click', () => {
      const answer = question.nextElementSibling;
      const icon = question.querySelector('i');

      answer.classList.toggle('hidden');
      icon.classList.toggle('fa-chevron-down');
      icon.classList.toggle('fa-chevron-up');
    });
  });

  // Initialize summary
  recalc();

  // Countdown timer
  let timeLeft = 15 * 60; // 15 minutes in seconds
  const countdownElement = document.getElementById('countdown-timer');

  const countdown = setInterval(() => {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    countdownElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

    if (timeLeft <= 0) {
      clearInterval(countdown);
      countdownElement.textContent = "Expired";
    }

    timeLeft--;
  }, 1000);
});
</script>
</body>
</html>